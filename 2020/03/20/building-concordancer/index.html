<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="About Learning"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=/css/custom.css><title>以 Python 實作 Concordancer |
Yongfu&#39;s Blog</title></head><body><div class=header><div class=header_title><span class=logo><!doctype html><svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="346pt" height="346pt" viewBox="0 0 346 346"><g transform="translate(0.000000,346.000000) scale(0.100000,-0.100000)" fill="#000" stroke="none"><path d="M1484 3328c8-40 19-53 84-94 36-24 52-40 50-52-2-10-12-16-23-15-173 21-208 16-293-38-17-12-66-30-108-40-117-29-354-149-354-178 0-5 20-6 45-3 28 3 45 1 45-6 0-6-32-32-70-57-98-65-105-78-90-162 7-38 20-88 30-113 21-50 17-65-33-117-23-25-32-46-38-93-7-49-17-70-50-112-39-50-41-55-33-98 4-25 8-95 8-156 1-104 3-113 29-151 15-22 41-52 58-67 16-14 29-33 29-41 0-33 71-189 122-267 30-46 82-113 116-149 56-60 60-67 47-85-27-39-155-291-155-305 1-8 45-43 99-79l97-64-7-47c-4-25-22-73-40-104-33-59-38-93-31-205 2-43-13-179-23-202-4-10-10-16-14-14-16 10-39-21-34-47 5-23 9-26 32-20 41 12 94 9 98-4 7-21-131-17-152 3-12 13-19 14-30 4-8-7-15-19-15-26 0-12 68-14 405-14 263 0 405 3 405 10 0 6-83 10-230 10h-230l-11 27c-7 20-6 28 3 35 24 15 136 8 272-17 167-31 201-31 351 0 123 25 190 30 283 18 47-5 53-8 50-27-3-21-8-21-235-24-198-2-233-5-233-17 0-13 54-15 409-15 406 0 409 0 404 20-7 27-43 48-43 25 0-22-34-19-56 6-15 17-16 22-4 29 9 6 17 5 22-3 4-6 10-8 14-4 4 4-1 16-11 27-14 16-21 18-28 8-6-9-7-8-3 5 3 10 0 20-9 23-7 3-11 12-8 20 3 8 0 21-7 29-20 24-30 87-17 103 6 8 11 44 11 82-1 53-8 82-32 136-28 60-58 163-50 168 2 1 41 19 88 40 47 21 89 42 94 46 17 17-80 244-135 314l-20 25-44-30c-48-32-188-1e2-245-118-19-6-83-27-142-46-116-39-236-53-303-37-39 10-38 10 27 11 37 1 102 7 145 13l78 13-140 6c-209 10-363 60-526 169-192 130-358 370-403 587l-7 31 78 7c43 3 90 8 104 11l26 5 17-148c11-91 23-157 33-172 15-24 16-24 147-18 203 9 528 54 544 75 11 13 13 54 10 179-4 165-3 173 33 173 5 0 9-30 9-67 0-87 18-240 30-263 16-29 99-34 392-23 222 8 270 12 292 26l26 17v160 160h28c16 0 63 3 104 6l75 7 7-42c6-40 3-47-49-122-31-43-51-79-45-79 6 0 37 13 69 30 64 32 73 47 87 140 9 63 36 112 84 152 45 39 49 52 20 68-11 6-38 35-61 66-39 51-42 60-50 144-5 49-15 106-24 126-14 35-14 39 4 58 27 29 35 69 21 110-8 26-24 42-63 64-58 33-81 55-95 93-15 37 17 103 63 130 19 12 35 25 35 30 0 17-68 9-147-16-42-13-79-22-81-20-12 11 33 56 80 82l52 28-34 3c-22 2-52-6-92-27-32-17-65-31-73-31-25 0-108 46-155 85-57 48-142 85-192 85-46 0-57 5-163 76-81 54-192 94-262 94-21 0-54 15-99 45-36 25-69 45-72 45-2 0-2-14 2-32zm-143-641c-13-16-43-98-38-104 2-2 20 11 40 29 20 18 56 44 79 56l43 24-48-48c-31-30-64-79-94-138l-45-91 59 61c45 48 84 75 178 124 66 34 130 70 143 79 32 23 183 11 261-21 50-20 72-23 204-23 143 0 149 1 166 23l17 24 19-44c23-51 167-203 279-295 48-39 81-73 82-86 2-12 12-62 22-112 11-49 18-91 17-93-4-4-199 50-208 58-4 4-9 45-11 91l-3 84-83-1c-82-1-83-1-112 32-42 48-124 84-191 84-49 0-66-7-186-76-90-52-130-81-127-90 4-10-2-14-19-14-24 0-24-2-27-92-3-87-4-93-25-96-20-3-22 2-28 75-3 43-8 83-10 90-3 9-79 10-307 6-167-3-334-8-373-12-80-7-75 2-61-121l7-66-93-38c-51-21-99-41-107-44-12-4-13 5-8 49 4 30 14 76 23 102 14 42 23 51 68 74 30 15 88 63 142 117 70 71 106 118 162 212 58 1e2 82 130 134 172 65 53 78 62 59 39zm897-336c20-10 48-30 61-44l23-25-43-7c-71-9-389-41-389-39 0 7 120 94 155 112 53 28 142 29 193 3zm216-399c4-152 4-285 1-294-4-9-14-19-23-23-9-4-143-9-298-12-248-5-281-4-287 10-7 18-24 241-31 413l-6 122 113 12c61 6 184 20 272 30 88 9 181 18 206 19l46 1 7-278zm-810 171c16-80 37-505 26-516-17-16-580-71-593-58-5 5-10 28-13 52-2 31-1 37 4 19 5-16 17-26 32-28 23-4 421 34 469 44 13 3 21 7 18 10-2 3-114-7-247-21-134-14-247-22-251-18-10 11-53 448-45 468 5 13 42 15 265 15 181 0 262 3 267 11 5 8-65 10-260 7-217-3-268-6-280-18-12-13-13-33-1-150 8-74 14-151 13-170-1-40-23 141-34 277l-7 93 169 3c93 1 235 4 316 5l146 2 6-27zm-587-455c-2-13-4-3-4 22 0 25 2 35 4 23 2-13 2-33 0-45zM975 191c3-5 1-12-5-16-5-3-10 1-10 9 0 18 6 21 15 7zm210-59c-9-9-25 19-24 43 0 16 2 15 15-8 9-16 13-32 9-35zm-55 9c0-11-4-9-14 4-8 11-12 24-9 28 7 11 23-12 23-32zm1108 17c-2-6-10-14-16-16-7-2-10 2-6 12 7 18 28 22 22 4zm44-10c-7-7-12-8-12-2 0 14 12 26 19 19 2-3-1-11-7-17zm83 2c4-6-5-10-20-10-15 0-24 4-20 10 3 6 12 10 20 10 8 0 17-4 20-10z"/><path d="M1260 2374c-42-23-1e2-75-1e2-89 0-4 16 7 35 24 56 49 95 65 155 65 66 0 115-23 214-1e2 71-57 90-63 121-40 16 12 6 20-116 90-131 74-137 76-199 75-49 0-76-7-110-25z"/><path d="M2070 2158c-102-11-189-25-195-30-7-7 2-9 30-4 104 16 474 48 489 43 15-6 16-32 14-244l-3-238-247-3c-141-1-248-6-248-11 0-9 469-4 498 5 10 3 12 58 10 251l-3 248-80 2c-44 0-163-8-265-19z"/><path d="M1969 1961c-62-62-20-171 66-171 27 0 44 8 66 29 62 62 20 171-66 171-27 0-44-8-66-29z"/><path d="M1414 1940c-60-24-73-112-25-161 39-38 87-39 130-3 26 22 31 33 31 71 0 77-65 122-136 93z"/><path d="M1512 1343c2-10 32-33 67-52 91-48 176-54 255-18 52 24 77 49 62 64-3 3-29-6-57-21-76-42-149-39-243 8-81 41-89 43-84 19z"/><path d="M933 693c15-2 39-2 55 0 15 2 2 4-28 4-30 0-43-2-27-4z"/><path d="M2388 673c6-2 18-2 25 0 6 3 1 5-13 5-14 0-19-2-12-5z"/><path d="M870 155c-6-8-10-19-8-24 1-6 8 1 15 14 13 28 11 31-7 10z"/><path d="M2546 157c3-10 9-15 12-12 3 3 0 11-7 18-10 9-11 8-5-6z"/></g></svg></span><span>Yongfu&#39;s Blog</span></div><div class=site_nav><span class=nav_link><a href=/>Home</a></span>
<span class=nav_link><a href=/post/>Posts</a></span>
<span class=nav_link><a href=/about/>About</a></span>
<span class=nav_link><a href=/index.xml>Subscribe</a></span></div></div><div class=main><article class=post><div class=article_header><div class=titles><h1>以 Python 實作 Concordancer</h1></div><div class=meta><div class=tags><a href="/post/?tag=linguistics">linguistics</a>
<a href="/post/?tag=python">python</a>
<a href="/post/?tag=vue">vue</a>
<a href="/post/?tag=docker">docker</a>
<a href="/post/?tag=%25E4%25B8%25AD%25E6%2596%2587">中文</a></div><div class=date><span class=inline-icon><svg aria-hidden="true" focusable="false" data-prefix="far" data-icon="calendar-alt" class="svg-inline--fa fa-calendar-alt fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="rgb(95, 95, 95)" d="M148 288h-40c-6.6.0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h48c26.5.0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3.0 6-2.7 6-6z"/></svg></span><span class=str>Mar 20, 2020</span></div></div></div><div class=article_content><p>每次接近學期末的時候，寫程式癮就會開始發作 (可能是不想面對無趣的期末報告)，這時候腦袋會蹦出許多很有趣的想法，然後就會迫不及待地想將這些想法實作出來。這次(2019 年末) 的程式癮刺激來源是實驗室的雲端硬碟裡的某個 (版權封閉) 中文語料庫，雖然該語料庫已有很好的搜尋界面，但<strong>我就是想 reinvent the wheel</strong>，自己手刻出一個 concordancer。不為了什麼，就只是因為這件事本身就很有樂趣。</p><h2 id=初步嘗試-for-loop-forever>初步嘗試：for loop&hellip; forever</h2><p>我本來並沒有太大的雄心壯志，就只想快速弄出個程式界面方便我查找 concordance，想說使用 <a href=https://www.nltk.org/book/ch01.html#searching-text>NLTK concordance</a> 應該很快就可以弄出我想的東西。但 NLTK concordance 只能使用 word form (或 pattern) 去搜尋 concordance，我的需求卻是要能<strong>使用 word form 或 PoS tag</strong> 搜尋語料庫 (類似 <a href=http://cwb.sourceforge.net/files/CQP_Tutorial/CQP_Tutorial.html>Corpus Query Langauge</a><sup class=footnote-ref id=fnref:cql><a href=#fn:cql>1</a></sup>，但不用這麼複雜)。但要自己用 Python 實作這個功能也頗簡單，於是我就自己手刻了這個功能。然而事實證明我太過天真了。語料庫的大小約 1000 萬個 token，而每次搜尋時，我的程式使用 for 迴圈跑過整個語料，因此要花非常非常非常久的時間才能完成搜尋。對於非資訊背景出生的我，第一次體驗 $O(n)$ 是件不可忽視的問題以及 Database 存在的必要性。</p><h2 id=重新規劃-database-python-vue>重新規劃： Database + Python + Vue</h2><p>為了解決上述問題我暫時擱置了這個專案 (寒假開始到春節期間) 去學習必備的一些知識<sup class=footnote-ref id=fnref:learn><a href=#fn:learn>2</a></sup>，最後比較有系統地重新規劃了這個 concordancer 的架構：</p><p><img src=https://img.yongfu.name/posts/concordancer-design.png style=width:100%></p><p>這個新的架構分成前<sup class=footnote-ref id=fnref:frontend><a href=#fn:frontend>3</a></sup>、後端，前端不是本文的重點 (原始碼<a href=https://github.com/liao961120/kwic>在此</a>)，就不細談。這邊直接舉一個實例說明這個 concordancer 如何運作：</p><ol><li><p>首先，使用者在前端輸入一個搜尋的字串 (keyword)，這個字串需符特定的格式：<code>[token 1][token 2][token 3]</code>。每對中括號代表一個 token，中括號內則是描述此 token 的特徵，如 word form 與 PoS tag，例如 <code>[word=&quot;打&quot; pos=&quot;V.*&quot;]</code> 即是要搜尋 word form 為 <code>打</code> 且詞類為動詞<sup class=footnote-ref id=fnref:postag-set><a href=#fn:postag-set>4</a></sup> 的 token。這裡的例子使用 <strong><code>[word.regex=&quot;^[他她]$&quot;][word=&quot;打&quot; pos=&quot;V.*&quot;]</code></strong>，下方的幾個例子都是符合這個搜尋的 2-gram:</p><ul><li><code>他/Nh 打/VC</code></li><li><code>她/Nh 打/VC</code></li></ul></li><li><p><strong><code>[word.regex=&quot;^[他她]$&quot;][word=&quot;打&quot; pos=&quot;V.*&quot;]</code></strong> 在傳給後端後，會先經過一個 <a href=https://yongfu.name/kwic-backend/html/doc/queryParser.html>parser</a> 處理，讓後端可以將這個 query 轉換成 SQL 去搜尋 database。在搜尋時，這邊僅會在 DB 中以<strong>其中一個 token 的資訊進行搜尋</strong>，並回傳所有符合的 token 於語料庫中的位置 (所在文件之 id、第幾個句子、token 於句子中的次序)。這些 token 是<strong>可能符合 keyword pattern 的「候選者」</strong> ，讓接下來的 n-gram 比對可以更快速 (search space 從整個語料庫減少到只剩這些「候選者」所組成的 n-gram)。</p></li><li><p>透過這些 token 的位置資訊，可以找出含有該 token 的 n-gram。例如，假設這裡使用 <code>[word=&quot;打&quot; pos=&quot;V.*&quot;]</code> 在 DB 當中搜尋，取得結果後，可以再比對此 token <strong>左邊</strong>的 token 是否符合 <code>[word.regex=&quot;^[他她]$&quot;]</code>。若符合，則保留此 2-gram，並取得該 2-gram 左右的 context，作為未來要回傳給使用者的 KWIC concordance。</p></li><li><p>跑完所有的「候選者」token，即可取得整個語料庫內，符合 keyword pattern 的 concordance。接下來僅需將資料轉換成 JSON 格式再傳到前端即可。</p></li></ol><h2 id=database-設計>Database 設計</h2><p>下圖是 Database<sup class=footnote-ref id=fnref:db><a href=#fn:db>5</a></sup> 的 table 設計，共有 3 個 table:</p><p><img src=https://img.yongfu.name/posts/db-design.png style=width:100%></p><ul><li><strong>Token</strong>: 將語料庫中的每種 token (即 type) 對應至 id。如此搜尋單一 token 的 word form 時，即可搜尋此較小的 table (列數等於語料庫中 type 的數量)，而不用跑過整個語料庫。</li><li><strong>Pos</strong>: 將語料庫中的每種 PoS tag 對應至 id。同上，可以快速找出符合的 token。</li><li><strong>Corpus</strong>: 保留語料庫 token 位置資訊的 table。搜尋完 <strong>Token</strong> 以及 <strong>Pos</strong> 兩 table 之後，即可透過 token 與 pos id 在 <strong>Corpus</strong> 裡找到符合的列 (e.g., <code>tk_id == 3</code> (<code>我</code>) 且 <code>pos_id == 1</code> (<code>Nh</code>)。這些列裡面含有這個 token 於語料庫中的位置 (<code>text_id</code>, <code>sent_idx</code>, <code>tk_idx</code>)。</li></ul><h2 id=原始碼-使用語料庫>原始碼 / 使用語料庫</h2><p>這個專案一開始是使用版權封閉的語料庫製作，因此語料庫的資料並未放在 GitHub，但後端的原始碼仍放在 <a href=https://github.com/liao961120/kwic-backend><code>liao961120/kwic-backend</code></a>。</p><p>為了讓這個專案至少能被使用，我另外爬了 <a href=https://github.com/liao961120/dcard-corpus>Dcard 作為語料</a> (500 多萬詞，大小約平衡語料庫的一半)，並包成 docker image，方便有興趣的人使用。要搜尋 Dcard 語料庫僅需依照下方的步驟：</p><ol><li><p>取得 docker image (僅第一次需執行)</p><pre><code class=language-bash>docker pull liao961120/dcard
</code></pre></li><li><p>執行後端 (執行後，請等待 cmd 出現 <code>Corpus Loaded</code> 的字串)</p><pre><code class=language-bash>docker run -it -p 127.0.0.1:1420:80 liao961120/dcard
</code></pre></li><li><p>前往 <a href=https://kwic.yongfu.name>https://kwic.yongfu.name</a> 使用前端界面</p></li></ol><div class=footnotes><hr><ol><li id=fn:cql>一開始曾想過直接使用現成的 corpus framework，例如 <a href=http://cwb.sourceforge.net>CWB</a>, <a href=https://inl.github.io/BlackLab>BlackLab</a> 等。但一方面研究這些 framework 要花許多精力，且因為研究的都是別人做好的 API，不容易學到比較低階、處理語料的問題。
<a class=footnote-return href=#fnref:cql>↩</a></li><li id=fn:learn>快速掃過 <a href=https://cs50.harvard.edu/x/2019>CS50</a> 的前 5 堂課 (我還是不會 C/C++)、複習之前<a href=https://cs50.harvard.edu/web/#sql>不怎麼認真看待的 SQL Database</a>以及閱讀 <a href=https://www.sqlite.org/queryplanner.html>SQLite 關於 indexing 的說明文件</a> (這最重要)。
<a class=footnote-return href=#fnref:learn>↩</a></li><li id=fn:frontend>雖然本來不打算做前端，但由於花了大量時間學習 Database 的概念，多花個幾小時刻個前端相比之下簡單許多 (這邊前端的功能不多)。
<a class=footnote-return href=#fnref:frontend>↩</a></li><li id=fn:postag-set>這裡的語料是經<a href=https://github.com/ckiplab/ckiptagger>中研院 ckiptagger</a> 斷詞，可<a href=https://github.com/ckiplab/ckiptagger/wiki/POS-Tags>於此</a>檢視其詞類標記集。
<a class=footnote-return href=#fnref:postag-set>↩</a></li><li id=fn:db>建立資料庫以及索引的原始碼位於 <a href=https://github.com/liao961120/dcard-corpus/blob/master/indexCorp.py><code>liao961120/dcard-corpus/indexCorp.py</code></a>。
<a class=footnote-return href=#fnref:db>↩</a></li></ol></div></div><br><br><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url='';this.page.identifier='';};(function(){var d=document,s=d.createElement('script');s.src='https://y-f-liao-s-page.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><div class=next-prev><div><span>PREV</span>
<a href=https://yongfu.name/2020/02/22/leipzigvue/>Recreating Leipizig.js with Vue for Interlinear Glossing</a></div><div><span>NEXT</span>
<a href=https://yongfu.name/2020/04/23/gloss-search/>Searching Interlinear Glosses Written in Word Documents</a></div></div></article><aside class="toc toc-right js-toc relative z-1 transition--300 absolute pa4 pt5 is-position-fixed"></aside></div><script src=https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.css><script>tocbot.init({tocSelector:'.js-toc',contentSelector:'.article_content',headingSelector:'h2, h3, h4',hasInnerContainers:true,collapseDepth:3,});</script><style>ol.toc-list{list-style-type:none}aside{position:fixed;top:15%!important;right:2%}.next-prev{margin-top:2.5em;border-top:2px solid #adadad8c;display:flex;flex-wrap:wrap;justify-content:space-between}.next-prev>div{min-width:150px;width:43%}.next-prev>div>span{display:block;width:100%;color:grey;font-weight:600;letter-spacing:1.5px;padding-bottom:.3rem;margin-top:.4rem}.next-prev>div:nth-child(2){text-align:right}.next-prev>div>a{text-decoration:none;color:#000;font-weight:600}</style><footer><div class=social></div><p class=site_info><span class=copyright>© 2017-2021</span></p><p class=theme_info>Powered by <a href=https://gohugo.io target=_blank>Hugo</a> &amp; <a href=https://github.com/liao961120/TeXtLite target=_blank>TeXtLite Theme</a>.</p></footer><div class=scrollBtn><span id=scrolltop onclick=window.scrollTo(0,0)>&#x25B2;</span>
<span id=scrollbottom onclick=window.scrollTo(0,document.body.scrollHeight)>&#x25BC;</span></div><style>div.scrollBtn{display:flex;flex-wrap:wrap;width:1em;position:fixed;bottom:1.1%;right:.8%}#scrolltop,#scrollbottom{line-height:1;font-size:1.4rem;color:var(--link-transitiion-light)}#scrolltop:hover,#scrollbottom:hover{cursor:pointer;color:green;font-size:1.6rem}</style><script>document.querySelectorAll('code, pre').forEach(elem=>{if(elem.className.startsWith('language'))
elem.className+=" line-numbers";if(['r','yaml','latex','markdown','bash','sh','json'].includes(elem.className)){elem.className="language-"+elem.className+" line-numbers";}})</script><link href=/js/prism.css rel=stylesheet><script src=/js/prism.js></script><script src=/js/prism-line-numbers.min.js></script><link rel=stylesheet href=/js/prism-line-numbers.min.css></body></html>