<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="About Learning"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=/css/custom.css><title>jieba 自訂詞庫斷詞 |
Yongfu&#39;s Blog</title></head><body><div class=header><div class=header_title><span class=logo><!doctype html><svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="346pt" height="346pt" viewBox="0 0 346 346"><g transform="translate(0.000000,346.000000) scale(0.100000,-0.100000)" fill="#000" stroke="none"><path d="M1484 3328c8-40 19-53 84-94 36-24 52-40 50-52-2-10-12-16-23-15-173 21-208 16-293-38-17-12-66-30-108-40-117-29-354-149-354-178 0-5 20-6 45-3 28 3 45 1 45-6 0-6-32-32-70-57-98-65-105-78-90-162 7-38 20-88 30-113 21-50 17-65-33-117-23-25-32-46-38-93-7-49-17-70-50-112-39-50-41-55-33-98 4-25 8-95 8-156 1-104 3-113 29-151 15-22 41-52 58-67 16-14 29-33 29-41 0-33 71-189 122-267 30-46 82-113 116-149 56-60 60-67 47-85-27-39-155-291-155-305 1-8 45-43 99-79l97-64-7-47c-4-25-22-73-40-104-33-59-38-93-31-205 2-43-13-179-23-202-4-10-10-16-14-14-16 10-39-21-34-47 5-23 9-26 32-20 41 12 94 9 98-4 7-21-131-17-152 3-12 13-19 14-30 4-8-7-15-19-15-26 0-12 68-14 405-14 263 0 405 3 405 10 0 6-83 10-230 10h-230l-11 27c-7 20-6 28 3 35 24 15 136 8 272-17 167-31 201-31 351 0 123 25 190 30 283 18 47-5 53-8 50-27-3-21-8-21-235-24-198-2-233-5-233-17 0-13 54-15 409-15 406 0 409 0 404 20-7 27-43 48-43 25 0-22-34-19-56 6-15 17-16 22-4 29 9 6 17 5 22-3 4-6 10-8 14-4 4 4-1 16-11 27-14 16-21 18-28 8-6-9-7-8-3 5 3 10 0 20-9 23-7 3-11 12-8 20 3 8 0 21-7 29-20 24-30 87-17 103 6 8 11 44 11 82-1 53-8 82-32 136-28 60-58 163-50 168 2 1 41 19 88 40 47 21 89 42 94 46 17 17-80 244-135 314l-20 25-44-30c-48-32-188-1e2-245-118-19-6-83-27-142-46-116-39-236-53-303-37-39 10-38 10 27 11 37 1 102 7 145 13l78 13-140 6c-209 10-363 60-526 169-192 130-358 370-403 587l-7 31 78 7c43 3 90 8 104 11l26 5 17-148c11-91 23-157 33-172 15-24 16-24 147-18 203 9 528 54 544 75 11 13 13 54 10 179-4 165-3 173 33 173 5 0 9-30 9-67 0-87 18-240 30-263 16-29 99-34 392-23 222 8 270 12 292 26l26 17v160 160h28c16 0 63 3 104 6l75 7 7-42c6-40 3-47-49-122-31-43-51-79-45-79 6 0 37 13 69 30 64 32 73 47 87 140 9 63 36 112 84 152 45 39 49 52 20 68-11 6-38 35-61 66-39 51-42 60-50 144-5 49-15 106-24 126-14 35-14 39 4 58 27 29 35 69 21 110-8 26-24 42-63 64-58 33-81 55-95 93-15 37 17 103 63 130 19 12 35 25 35 30 0 17-68 9-147-16-42-13-79-22-81-20-12 11 33 56 80 82l52 28-34 3c-22 2-52-6-92-27-32-17-65-31-73-31-25 0-108 46-155 85-57 48-142 85-192 85-46 0-57 5-163 76-81 54-192 94-262 94-21 0-54 15-99 45-36 25-69 45-72 45-2 0-2-14 2-32zm-143-641c-13-16-43-98-38-104 2-2 20 11 40 29 20 18 56 44 79 56l43 24-48-48c-31-30-64-79-94-138l-45-91 59 61c45 48 84 75 178 124 66 34 130 70 143 79 32 23 183 11 261-21 50-20 72-23 204-23 143 0 149 1 166 23l17 24 19-44c23-51 167-203 279-295 48-39 81-73 82-86 2-12 12-62 22-112 11-49 18-91 17-93-4-4-199 50-208 58-4 4-9 45-11 91l-3 84-83-1c-82-1-83-1-112 32-42 48-124 84-191 84-49 0-66-7-186-76-90-52-130-81-127-90 4-10-2-14-19-14-24 0-24-2-27-92-3-87-4-93-25-96-20-3-22 2-28 75-3 43-8 83-10 90-3 9-79 10-307 6-167-3-334-8-373-12-80-7-75 2-61-121l7-66-93-38c-51-21-99-41-107-44-12-4-13 5-8 49 4 30 14 76 23 102 14 42 23 51 68 74 30 15 88 63 142 117 70 71 106 118 162 212 58 1e2 82 130 134 172 65 53 78 62 59 39zm897-336c20-10 48-30 61-44l23-25-43-7c-71-9-389-41-389-39 0 7 120 94 155 112 53 28 142 29 193 3zm216-399c4-152 4-285 1-294-4-9-14-19-23-23-9-4-143-9-298-12-248-5-281-4-287 10-7 18-24 241-31 413l-6 122 113 12c61 6 184 20 272 30 88 9 181 18 206 19l46 1 7-278zm-810 171c16-80 37-505 26-516-17-16-580-71-593-58-5 5-10 28-13 52-2 31-1 37 4 19 5-16 17-26 32-28 23-4 421 34 469 44 13 3 21 7 18 10-2 3-114-7-247-21-134-14-247-22-251-18-10 11-53 448-45 468 5 13 42 15 265 15 181 0 262 3 267 11 5 8-65 10-260 7-217-3-268-6-280-18-12-13-13-33-1-150 8-74 14-151 13-170-1-40-23 141-34 277l-7 93 169 3c93 1 235 4 316 5l146 2 6-27zm-587-455c-2-13-4-3-4 22 0 25 2 35 4 23 2-13 2-33 0-45zM975 191c3-5 1-12-5-16-5-3-10 1-10 9 0 18 6 21 15 7zm210-59c-9-9-25 19-24 43 0 16 2 15 15-8 9-16 13-32 9-35zm-55 9c0-11-4-9-14 4-8 11-12 24-9 28 7 11 23-12 23-32zm1108 17c-2-6-10-14-16-16-7-2-10 2-6 12 7 18 28 22 22 4zm44-10c-7-7-12-8-12-2 0 14 12 26 19 19 2-3-1-11-7-17zm83 2c4-6-5-10-20-10-15 0-24 4-20 10 3 6 12 10 20 10 8 0 17-4 20-10z"/><path d="M1260 2374c-42-23-1e2-75-1e2-89 0-4 16 7 35 24 56 49 95 65 155 65 66 0 115-23 214-1e2 71-57 90-63 121-40 16 12 6 20-116 90-131 74-137 76-199 75-49 0-76-7-110-25z"/><path d="M2070 2158c-102-11-189-25-195-30-7-7 2-9 30-4 104 16 474 48 489 43 15-6 16-32 14-244l-3-238-247-3c-141-1-248-6-248-11 0-9 469-4 498 5 10 3 12 58 10 251l-3 248-80 2c-44 0-163-8-265-19z"/><path d="M1969 1961c-62-62-20-171 66-171 27 0 44 8 66 29 62 62 20 171-66 171-27 0-44-8-66-29z"/><path d="M1414 1940c-60-24-73-112-25-161 39-38 87-39 130-3 26 22 31 33 31 71 0 77-65 122-136 93z"/><path d="M1512 1343c2-10 32-33 67-52 91-48 176-54 255-18 52 24 77 49 62 64-3 3-29-6-57-21-76-42-149-39-243 8-81 41-89 43-84 19z"/><path d="M933 693c15-2 39-2 55 0 15 2 2 4-28 4-30 0-43-2-27-4z"/><path d="M2388 673c6-2 18-2 25 0 6 3 1 5-13 5-14 0-19-2-12-5z"/><path d="M870 155c-6-8-10-19-8-24 1-6 8 1 15 14 13 28 11 31-7 10z"/><path d="M2546 157c3-10 9-15 12-12 3 3 0 11-7 18-10 9-11 8-5-6z"/></g></svg></span><span>Yongfu&#39;s Blog</span></div><div class=site_nav><span class=nav_link><a href=/>Home</a></span>
<span class=nav_link><a href=/post/>Posts</a></span>
<span class=nav_link><a href=/about/>About</a></span>
<span class=nav_link><a href=/index.xml>Subscribe</a></span></div></div><div class=main><article class=post><div class=article_header><div class=titles><h1>jieba 自訂詞庫斷詞</h1></div><div class=meta><div class=tags><a href="/post/?tag=text-mining">text mining</a>
<a href="/post/?tag=r">r</a>
<a href="/post/?tag=%25E4%25B8%25AD%25E6%2596%2587">中文</a></div><div class=date><span class=inline-icon><svg aria-hidden="true" focusable="false" data-prefix="far" data-icon="calendar-alt" class="svg-inline--fa fa-calendar-alt fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="rgb(95, 95, 95)" d="M148 288h-40c-6.6.0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h48c26.5.0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3.0 6-2.7 6-6z"/></svg></span><span class=str>Jul 31, 2018</span></div></div></div><div class=article_content><p>在進行中文 Text Mining 前處理時，必須先經過斷詞處理。社群當中存在相當好的斷詞處理工具，如 <a href=https://github.com/fxsjy/jieba>jieba</a>。但斷詞時常遇到一個問題：<strong>文本中重要的詞彙因為不常見於其它地方而被斷開，像是人物角色名稱</strong>。要處理這個問題，需將自訂詞庫提供給斷詞套件，才不會將重要詞彙斷開。</p><p>這邊將使用 <a href=https://github.com/qinwf/jiebaR>jiebaR</a>，介紹使用自訂詞庫的斷詞方式，並提供自訂詞庫的製作方式。</p><div class="section level2"><h2>示範語料</h2><p>這裡使用金庸<strong><a href=https://zh.wikipedia.org/wiki/%E7%A5%9E%E9%B5%B0%E4%BF%A0%E4%BE%B6>神雕俠侶</a>第三十二回 — 情是何物</strong>作為斷詞的文本。武俠小說在此是個很好的例子，因為裡面有許多人物名稱和專有名詞。</p><p>因為著作權問題<a href=#fn1 class=footnoteRef id=fnref1><sup>1</sup></a>，語料的原始檔(<code>032.txt</code>)將不會出現在本文的 <a href=https://github.com/liao961120/blog/tree/master/post_source/jieba-dict>GitHub repo</a> 中。</p></div><div class="section level2"><h2>製作自訂詞庫</h2><p>取得小說這類文本的角色名稱與特殊名詞乍看之下可能非常耗工耗時，但有些時候其實相當容易，尤其是著名的小說。這要歸功於<a href=https://en.wikipedia.org/wiki/Main_Page>維基百科</a>，因為越是著名的小說，其越有可能有詳盡的維基百科頁面，而<strong>維基百科對製作詞庫最重要的特色在於其頁面的超連結</strong>，因為通常只有<strong>專有名詞才會成為一個維基頁面上的超連結</strong>。</p><p>這邊使用維基百科的<a href=https://zh.wikipedia.org/wiki/%E7%A5%9E%E9%B5%B0%E4%BF%A0%E4%BE%B6%E8%A7%92%E8%89%B2%E5%88%97%E8%A1%A8>神鵰俠侶角色列表</a>作為詞庫的來源。以下使用<code>rvest</code>套件清理此頁面：</p><pre><code class=r>library(rvest)
library(dplyr)
library(magrittr)
library(knitr)

path &lt;- &quot;神鵰俠侶角色列表.html&quot; 
# 這裡已先行下載網頁，若無可直接使用網址

data &lt;- read_html(path) %&gt;% 
    html_nodes(&quot;ul&quot;) %&gt;% html_nodes(&quot;li&quot;) %&gt;%
    html_nodes(&quot;a&quot;) %&gt;% html_text()</code></pre><p>觀察頁面後，可發現多數與小說相關的詞彙都位在 unordered list 下的連結內文(&lt;a&gt; tag)，因此透過 3 個<code>html_nodes()</code>取得連結，並用<code>html_text()</code>擷取連結內文。</p><p>接著看看擷取的詞彙，可以發現這些詞彙依照順序大致可區分成三個來源：</p><ol style=list-style-type:decimal><li>自維基頁面的<strong>目錄</strong>擷取之連結</li><li>內文的連結(這是我們要的)</li><li>其它連結<ul><li>對應至頁面最下方，與小說有關但並非小說主要內容的連結，如，「射雕英雄传角色列表」。另外，也包含維基百科頁面的固定連結，如「編輯」、「討論」、「下載為PDF」等。</li></ul></li></ol><pre><code class=r>data &lt;- unique(data)

data[1:3]</code></pre><pre><code class=nohighlight>[1] &quot;1 主角&quot;           &quot;2 桃花島&quot;         &quot;2.1 「北丐」門派&quot;</code></pre><pre><code class=r>data[21:25]</code></pre><pre><code class=nohighlight>[1] &quot;楊過&quot;       &quot;射鵰英雄傳&quot; &quot;楊康&quot;       &quot;穆念慈&quot;     &quot;全真教&quot;    </code></pre><pre><code class=r>data[207:211]</code></pre><pre><code class=nohighlight>[1] &quot;射雕英雄传角色列表&quot; &quot;倚天屠龙记角色列表&quot; &quot;查&quot;                
[4] &quot;论&quot;                 &quot;编&quot;                </code></pre><p>我們要的內容介在<code>data[21]</code>(楊過)至<code>data[206]</code>(樊一翁)之間。此外，亦可手動加入連結中沒有的詞彙：</p><pre><code class=r>data &lt;- as_data_frame(data[21:206]) %&gt;% 
    rbind(&quot;過兒&quot;, &quot;靖哥哥&quot;) # 手動額外輸入

head(data, 4) %&gt;% kable(&quot;markdown&quot;, align=&quot;c&quot;)</code></pre><table><thead><tr class=header><th align=center>value</th></tr></thead><tbody><tr class=odd><td align=center>楊過</td></tr><tr class=even><td align=center>射鵰英雄傳</td></tr><tr class=odd><td align=center>楊康</td></tr><tr class=even><td align=center>穆念慈</td></tr></tbody></table><p>最後，將<code>data</code>存成<code>.csv</code>檔，方便未來使用：</p><pre><code class=r>readr::write_csv(data, &quot;sdxl_wordlist.csv&quot;)</code></pre></div><div id=jiebar- class="section level2"><h2>jiebaR 斷詞</h2><p>準備好自訂詞庫後，要開始對文本進行斷詞。</p><p>jiebaR 斷詞可以選擇外來檔案或將檔案讀入後在進行斷詞，這邊將文本檔案讀入再斷詞：</p><pre><code class=r>library(stringr)
raw_text &lt;- readr::read_file(&quot;032.txt&quot;)

raw_text %&gt;% str_trunc(80)</code></pre><pre><code class=nohighlight>[1] &quot;第三十二回　情是何物\r\n\r\n　　當黃蓉、一燈、郭芙等被困大廳之時，楊過和小龍女正在花前並肩共語。不久程英和陸無雙到來。小龍女見程英溫雅靦腆，甚是投緣，拉住...&quot;</code></pre><div class="section level3"><h3>無自訂詞庫</h3><p>首先，我們可以看看沒有自訂詞庫的斷詞效果：</p><pre><code class=r>library(jiebaR)
stop_words &lt;- readr::read_table2(&quot;stop-zh-tw-withpunc&quot;,
                                 col_names = F) %&gt;%
                     rbind(&quot;\n&quot;, &quot;\r&quot;) %&gt;%
                     set_names(&quot;word&quot;)

seg &lt;- worker(bylines = F, symbol = T)

segment(raw_text, seg) %&gt;%
    as_data_frame() %&gt;% 
    anti_join(stop_words, by=c(&quot;value&quot;=&quot;word&quot;)) %&gt;%
    count(value) %&gt;%
    arrange(desc(n)) %&gt;%
    head() %&gt;% kable(&quot;markdown&quot;, align=&quot;c&quot;)</code></pre><table><thead><tr class=header><th align=center>value</th><th align=center>n</th></tr></thead><tbody><tr class=odd><td align=center>道</td><td align=center>156</td></tr><tr class=even><td align=center>小龍女</td><td align=center>115</td></tr><tr class=odd><td align=center>楊</td><td align=center>91</td></tr><tr class=even><td align=center>公孫止</td><td align=center>86</td></tr><tr class=odd><td align=center>楊過</td><td align=center>76</td></tr><tr class=even><td align=center>黃</td><td align=center>65</td></tr></tbody></table><p>可以看到有些斷詞是正確的，如「公孫止」。但某些似乎常常斷錯，例如，「黃蓉」、「楊過」(某些似乎斷錯，導致有許多單獨的「楊」)。</p></div><div class="section level3"><h3>使用自訂詞庫</h3><p>在<code>jiebaR::worker()</code>中設定自訂詞庫的位置：<code>user = &quot;sdxl_wordlist.csv&quot;</code>，即可在斷詞系統中新增字典：</p><pre><code class=r>seg &lt;- worker(bylines = F, symbol = T,
              user = &quot;sdxl_wordlist.csv&quot;)

segment(raw_text, seg) %&gt;%
    as_data_frame() %&gt;% 
    anti_join(stop_words, by=c(&quot;value&quot;=&quot;word&quot;)) %&gt;%
    count(value) %&gt;%
    arrange(desc(n)) %&gt;%
    head() %&gt;% kable(&quot;markdown&quot;, align=&quot;c&quot;)</code></pre><table><thead><tr class=header><th align=center>value</th><th align=center>n</th></tr></thead><tbody><tr class=odd><td align=center>楊過</td><td align=center>187</td></tr><tr class=even><td align=center>道</td><td align=center>150</td></tr><tr class=odd><td align=center>小龍女</td><td align=center>119</td></tr><tr class=even><td align=center>公孫止</td><td align=center>104</td></tr><tr class=odd><td align=center>黃蓉</td><td align=center>95</td></tr><tr class=even><td align=center>李莫愁</td><td align=center>59</td></tr></tbody></table><p>可以看到使用自訂詞庫後，斷詞變得有意義多了。</p></div></div><div class=footnotes><ol><li id=fn1><p>本文目的僅在促進教育與學術，並無營利企圖。且本文僅顯示極少的小說內容，應屬合理使用。若有侵犯著作權的疑慮，麻煩透過 <a href=mailto:liaomovie2@gmail.com>Email</a> 與我聯絡。<a href=#fnref1>↩</a></p></li></ol></div><p style=text-align:right;font-size:7px;margin-top:0;margin-bottom:0;padding-top:0;padding-bottom:1px>Last updated: 2018-11-10</p></div><br><br><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url='';this.page.identifier='';};(function(){var d=document,s=d.createElement('script');s.src='https://y-f-liao-s-page.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><div class=next-prev><div><span>PREV</span>
<a href=https://yongfu.name/2018/07/28/quanteda-tutorial/>Text Mining 前處理</a></div><div><span>NEXT</span>
<a href=https://yongfu.name/2018/08/02/rblogger-criteria/>Making Jekyll Blog Suitable for R-bloggers</a></div></div></article><aside class="toc toc-right js-toc relative z-1 transition--300 absolute pa4 pt5 is-position-fixed"></aside></div><script src=https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.css><script>tocbot.init({tocSelector:'.js-toc',contentSelector:'.article_content',headingSelector:'h2, h3, h4',hasInnerContainers:true,collapseDepth:3,});</script><style>ol.toc-list{list-style-type:none}aside{position:fixed;top:15%!important;right:2%}.next-prev{margin-top:2.5em;border-top:2px solid #adadad8c;display:flex;flex-wrap:wrap;justify-content:space-between}.next-prev>div{min-width:150px;width:43%}.next-prev>div>span{display:block;width:100%;color:grey;font-weight:600;letter-spacing:1.5px;padding-bottom:.3rem;margin-top:.4rem}.next-prev>div:nth-child(2){text-align:right}.next-prev>div>a{text-decoration:none;color:#000;font-weight:600}</style><footer><div class=social></div><p class=site_info><span class=copyright>© 2017-2021</span></p><p class=theme_info>Powered by <a href=https://gohugo.io target=_blank>Hugo</a> &amp; <a href=https://github.com/liao961120/TeXtLite target=_blank>TeXtLite Theme</a>.</p></footer><div class=scrollBtn><span id=scrolltop onclick=window.scrollTo(0,0)>&#x25B2;</span>
<span id=scrollbottom onclick=window.scrollTo(0,document.body.scrollHeight)>&#x25BC;</span></div><style>div.scrollBtn{display:flex;flex-wrap:wrap;width:1em;position:fixed;bottom:1.1%;right:.8%}#scrolltop,#scrollbottom{line-height:1;font-size:1.4rem;color:var(--link-transitiion-light)}#scrolltop:hover,#scrollbottom:hover{cursor:pointer;color:green;font-size:1.6rem}</style><script>document.querySelectorAll('code, pre').forEach(elem=>{if(elem.className.startsWith('language'))
elem.className+=" line-numbers";if(['r','yaml','latex','markdown','bash','sh','json'].includes(elem.className)){elem.className="language-"+elem.className+" line-numbers";}})</script><link href=/js/prism.css rel=stylesheet><script src=/js/prism.js></script><script src=/js/prism-line-numbers.min.js></script><link rel=stylesheet href=/js/prism-line-numbers.min.css></body></html>